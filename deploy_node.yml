---

- block:

  # Ansible hosts can serve as an abstraction for tosca nodes
  # as they encapsulate variables.
  - name: Add node host
    add_host:
      name: "{{ deployment_unit.uid }}"

  - name: Gather facts
    gather_facts:

  - name: Deploy node
    include_role:
      name: "{{ deployment_unit.role }}"
    vars:
      uid: "{{ deployment_unit.uid }}"
      config: "{{ deployment_unit.config }}"
      ansible_become: "{{ deployment_unit.become | default(false) }}"

  # Here node status can be reported to Michman.
  - name: Return status to michman
    debug:
      msg: "OK"

  # This line is needed to run the block on a particular
  # host (or group).
  delegate_to: "{{ deployment_unit.host }}"
